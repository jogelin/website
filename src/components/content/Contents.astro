---
import { getCollection } from 'astro:content';
import TalkCard from './TalkCard.astro';
import PostCard from './PostCard.astro';
import { isInstanceOfBlogPost } from '../../content/blog/_schema';
import { isInstanceOfTalk } from '../../loaders/talks/schemas';

const posts = await getCollection('posts', ({ data }) => !data.draft);

const conferences = await getCollection('conferences');
const cfps = await getCollection('cfps');
const talks = (await getCollection('talks')).map((talk) => ({
  ...talk,
  data: {
    ...talk.data,
    properties: {
      ...talk.data.properties,
      conference: conferences.find((c) => c.id === talk.data.properties.conference.relation[0].id)?.data?.properties,
      talk: cfps.find((c) => c.id === talk.data.properties.talk.relation[0].id)?.data?.properties,
    },
  },
}));

const getTime = (content: any) => {
  if (content.collection === 'talks') {
    return new Date(content.data.properties.conference.date?.date?.start).getTime();
  }
  if (content.collection === 'posts') {
    return new Date(content.data.publishedAt).getTime();
  }

  return 0;
};
const sortedContents = [...posts, ...talks].sort((a, b) => getTime(b) - getTime(a));

function groupContentsForMasonry<T>(contents: T[], columns: number): T[][] {
  const grouped = Array.from({ length: columns }, () => []) as T[][];
  contents.forEach((content, index) => {
    grouped[index % columns].push(content);
  });
  return grouped;
}

const columns = 3;
const masonryContents = groupContentsForMasonry(sortedContents, columns);
---

<div class="section-container">
  <div class="section-header">
    <span class="section-label">Content</span>
    <h2 class="section-title">Articles & Talks</h2>
    <p class="section-subtitle">Sharing knowledge on Nx, AI tooling, and developer experience</p>
  </div>

  <div class="posts-masonry">
  {
    masonryContents.map((col) => (
      <div class="column">
        {col.map((content) =>
          isInstanceOfBlogPost(content.data) ? (
            <PostCard post={content as { id: string; data: any }} />
          ) : isInstanceOfTalk(content.data.properties) ? (
            <TalkCard talk={content.data.properties} />
          ) : (
            'ERROR'
          ),
        )}
      </div>
    ))
  }
  </div>
</div>

<style>
  .section-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 24px;
  }

  .posts-masonry {
    columns: 1;
    gap: 16px;
  }

  @media (min-width: 768px) {
    .posts-masonry {
      columns: 3;
    }
  }

  @media (max-width: 600px) {
    .section-container {
      padding: 0 16px;
    }
  }

  .section-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .section-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: #10b981;
    display: block;
    margin-bottom: 8px;
  }

  .section-title {
    font-size: clamp(28px, 4vw, 36px);
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 8px;
  }

  :global(.dark) .section-title {
    color: #e2e8f0;
  }

  .section-subtitle {
    font-size: 16px;
    color: #64748b;
  }

  :global(.dark) .section-subtitle {
    color: #94a3b8;
  }

  .column {
    break-inside: avoid;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
</style>
