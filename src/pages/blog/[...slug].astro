---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Footer from '../../components/Footer.astro';
import Navbar from '../../components/Navbar.astro';
import AvailabilityBar from '../../components/AvailabilityBar.astro';
import BlogPostLayout from '../../layouts/BlogPostLayout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

// Calculate reading time from content
const wordCount = post.body?.split(/\s+/).length || 0;
const readingTime = Math.max(1, Math.ceil(wordCount / 200));

// Build meta image URL (must be absolute for Medium import)
const baseUrl = 'https://smartsdlc.dev';
const ogImage = post.data.coverImage
  ? `${baseUrl}${post.data.coverImage}`
  : `${baseUrl}/linkedin-banner.png`;
const canonicalUrl = `${baseUrl}/blog/${post.id}`;
---

<Layout
  title={`${post.data.title} | Jonathan Gelin`}
  description={post.data.subtitle || ''}
  ogImage={ogImage}
  ogType="article"
  canonicalUrl={canonicalUrl}
>
  <Fragment slot="head">
    <meta name="author" content={post.data.author.name} />
    <meta property="article:published_time" content={post.data.publishedAt.toISOString()} />
    <meta property="article:author" content={post.data.author.name} />
    {post.data.tags.map((tag) => <meta property="article:tag" content={tag} />)}
  </Fragment>

  <AvailabilityBar />
  <Navbar activeLink="blog" />
  <main>
    <BlogPostLayout post={post.data} readingTime={readingTime}>
      <Content />
    </BlogPostLayout>
  </main>
  <Footer />
</Layout>

<style>
  main {
    min-height: 100vh;
    padding-top: 40px;
  }
</style>
